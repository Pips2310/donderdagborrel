<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Donderdagen 2025 - Statistieken</title>
    <!-- Tailwind CSS CDN for easy styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom font for a clean look */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Lichtgrijze achtergrond */
        }
        canvas {
            display: block;
            margin: 20px auto;
            max-width: 100%;
            height: auto;
        }
        /* Tooltip styling */
        #tooltip {
            position: absolute;
            background-color: rgba(31, 41, 55, 0.9); /* Tailwind gray-800 met opaciteit */
            color: #ffffff;
            font-size: 0.75rem; /* text-xs */
            padding: 0.25rem 0.5rem; /* px-2 py-1 */
            border-radius: 0.375rem; /* rounded-md */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); /* shadow-lg */
            pointer-events: none; /* Laat muisgebeurtenissen door */
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 50; /* z-50 */
        }
        /* Modal overlay styling */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
        .modal {
            background-color: #ffffff;
            padding: 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
            position: relative;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-4 bg-gray-100 text-gray-800">
    <!-- Hoofdcontainer voor grafieken en eigen statistieken -->
    <div class="container bg-white p-8 rounded-lg shadow-xl text-center max-w-md w-11/12 mb-5">
        <h2 class="text-3xl font-bold text-black mb-6">Statistieken</h2>
        
        <!-- Subtitel om te verduidelijken dat de statistieken van het jaar tot nu toe zijn -->
        <p class="text-sm text-gray-500 mb-6">De statistieken hieronder tonen de gegevens voor de donderdagen tot en met vandaag in 2025.</p>

        <!-- Cirkeldiagrammen -->
        <h4 class="text-xl font-semibold text-gray-700 mt-8 mb-2 text-center">Aanwezigheid</h4>
        <canvas id="attendancePieChart" width="300" height="300"></canvas>
        <!-- Aangepaste legendestijl voor kolommen -->
        <div id="attendanceLegend" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-2 text-xs mt-4 text-left"></div>

        <h4 class="text-xl font-semibold text-gray-700 mt-8 mb-2 text-center">Host</h4>
        <canvas id="hostsPieChart" width="300" height="300"></canvas>
        <!-- Aangepaste legendestijl voor kolommen -->
        <div id="hostsLegend" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-2 text-xs mt-4 text-left"></div>
    </div>

    <!-- Terugknop -->
    <button class="terug-btn mt-6 py-3 px-6 bg-[#1d72b8] text-white font-semibold rounded-lg shadow-md hover:bg-[#155a99] transition duration-300 ease-in-out" onclick="window.location.href='index.html'">Terug naar overzicht</button>

    <!-- Tooltip element -->
    <div id="tooltip"></div>

    <!-- Modal voor aanwezigheidslijst -->
    <div id="attendanceModalOverlay" class="modal-overlay hidden">
        <div class="modal w-11/12 max-w-md">
            <button id="closeModalBtn" class="absolute top-2 right-2 text-gray-500 hover:text-gray-700 text-2xl font-bold">&times;</button>
            <h3 id="modalTitle" class="text-2xl font-bold mb-4"></h3>
            <ul id="attendanceDatesList" class="list-disc list-inside space-y-1"></ul>
        </div>
    </div>

    <script>
        / Definieer API_URL - BELANGRIJK: Voor productie moet dit een veilige, niet-localhost URL zijn.
        / In een Canvas-omgeving kan dit dynamisch worden geleverd.
        const API_URL = '/api'; / Gecorrigeerde API URL
        let gebruikersnaam = localStorage.getItem('gebruikersnaam') || '';

        / Globale variabele voor het aantal donderdagen tot vandaag, gedeeld door meerdere functies
        let numThursdaysUntilToday;

        / Grafiekelementen
        const attendancePieChartCanvas = document.getElementById('attendancePieChart');
        const attendanceLegendDiv = document.getElementById('attendanceLegend');
        const hostsPieChartCanvas = document.getElementById('hostsPieChart');
        const hostsLegendDiv = document.getElementById('hostsLegend');
        const tooltip = document.getElementById('tooltip');
        
        / Modal-elementen
        const attendanceModalOverlay = document.getElementById('attendanceModalOverlay');
        const modalTitle = document.getElementById('modalTitle');
        const attendanceDatesList = document.getElementById('attendanceDatesList');
        const closeModalBtn = document.getElementById('closeModalBtn');

        / Globale variabele om de data voor "Overige" op te slaan
        let otherAttendeesData = [];

        / Kleurenpalet voor de cirkeldiagrammen
        const colorPalette = [
            '#FF6384', / Roodachtig
            '#36A2EB', / Blauw
            '#FFCE56', / Geel
            '#4BC0C0', / Turkoois
            '#9966FF', / Paars
            '#FF9F40', / Oranje
            '#2ECC71', / Groen
            '#E74C3C', / Donkerrood
            '#3498DB', / Helderblauw
            '#F1C40F', / Goudgeel
            '#1ABC9C', / Zeegroen
            '#8E44AD', / Donkerpaars
            '#D35400', / Pompoenoranje
            '#C0392B', / Baksteenrood
            '#2980B9', / Staalblauw
            '#F39C12', / Mosterdgeel
            '#27AE60', / Smaragdgroen
            '#7D3C98', / Donkerder paars
            '#E67E22', / Worteloranje
            '#16A085'  / Donkerder zeegroen
        ];

        /**
         * Toont een foutmelding op de UI.
         * @param {HTMLElement} element - Het HTML-element om het bericht in weer te geven.
         * @param {string} message - Het foutbericht om weer te geven.
         */
        function displayErrorMessage(element, message) {
            / Deze functie wordt niet langer gebruikt voor de hoofdweergave van statistieken, maar is bewaard voor mogelijk toekomstig gebruik of debugging
            console.error("Foutmelding weergegeven:", message);
        }

        /**
         * Berekent het aantal donderdagen vanaf 1 januari 2025 tot de huidige datum (inclusief).
         * @returns {number} Het totale aantal donderdagen.
         */
        function calculateThursdaysUntilToday() {
            let count = 0;
            / Start van 2025 in UTC om tijdzoneproblemen te voorkomen die de dagberekeningen beïnvloeden.
            const startDate = new Date('2025-01-01T00:00:00Z');
            const today = new Date();
            / Normaliseer vandaag naar het begin van de dag UTC voor consistente vergelijking.
            today.setUTCHours(0, 0, 0, 0);

            / Vind de eerste donderdag op of na startDate.
            while (startDate.getUTCDay() !== 4) { / 4 staat voor donderdag (0=zondag, 1=maandag, ..., 6=zaterdag)
                startDate.setUTCDate(startDate.getUTCDate() + 1);
            }

            / Loop door donderdagen, verhoog de teller, totdat startDate vandaag passeert.
            while (startDate <= today) {
                count++;
                startDate.setUTCDate(startDate.getUTCDate() + 7); / Ga naar de volgende donderdag
            }
            return count;
        }

        /**
         * Berekent het aantal resterende donderdagen in het jaar 2025 vanaf de huidige datum (exclusief).
         * @returns {number} Het aantal resterende donderdagen.
         */
        function calculateRemainingThursdays() {
            let count = 0;
            const today = new Date();
            today.setUTCHours(0, 0, 0, 0); / Normaliseer vandaag naar het begin van de dag UTC

            / Einde van 2025 in UTC
            const endDate = new Date('2025-12-31T23:59:59Z');

            / Vind de volgende donderdag *na* vandaag
            let nextThursday = new Date(today);
            nextThursday.setUTCHours(0, 0, 0, 0); / Zorg ervoor dat het het begin van de dag is

            / Als vandaag donderdag is, moeten we naar de *volgende* donderdag gaan om de resterende te tellen
            / Als vandaag geen donderdag is, vind dan de eerstvolgende donderdag
            while (nextThursday.getUTCDay() !== 4 || nextThursday <= today) {
                nextThursday.setUTCDate(nextThursday.getUTCDate() + 1);
            }

            / Loop door donderdagen tot het einde van 2025
            while (nextThursday <= endDate) {
                count++;
                nextThursday.setUTCDate(nextThursday.getUTCDate() + 7); / Ga naar de volgende donderdag
            }
            return count;
        }

        /**
         * Berekent het totale aantal donderdagen in een bepaald jaar.
         * @param {number} year - Het jaar waarvoor donderdagen moeten worden berekend.
         * @returns {number} Het totale aantal donderdagen in het jaar.
         */
        function calculateTotalThursdaysInYear(year) {
            let count = 0;
            const startDate = new Date(`${year}-01-01T00:00:00Z`);
            const endDate = new Date(`${year}-12-31T23:59:59Z`);

            / Vind de eerste donderdag op of na startDate
            while (startDate.getUTCDay() !== 4) {
                startDate.setUTCDate(startDate.getUTCDate() + 1);
            }

            / Loop door donderdagen tot endDate
            while (startDate <= endDate) {
                count++;
                startDate.setUTCDate(startDate.getUTCDate() + 7); / Ga naar de volgende donderdag
            }
            return count;
        }

        /**
         * Haalt aanwezigheidsgegevens op voor alle gebruikers.
         * @returns {Promise<Array<{user: string, count: number}>>} Een promise die resulteert in een array met aanwezigheidsgegevens.
         */
        async function fetchAllAttendanceSummary() {
            try {
                const response = await fetch(`${API_URL}/attendance/summary`, {
                    credentials: 'include'
                });
                if (!response.ok) {
                    throw new Error(`HTTP-fout! status: ${response.status}`);
                }
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('Fout bij het ophalen van aanwezigheidsgegevens:', error);
                return [];
            }
        }

        /**
         * Haalt de specifieke aanwezigheidsdata (dagen) op voor een gebruiker.
         * @param {string} user - De naam van de gebruiker.
         * @returns {Promise<Array<string>>} Een promise die resulteert in een array van datums.
         */
        async function fetchUserAttendanceDates(user) {
            try {
                const response = await fetch(`${API_URL}/attendance/user/${encodeURIComponent(user)}`, {
                    credentials: 'include'
                });
                if (!response.ok) {
                    / Als de gebruiker niet is ingelogd of geen rechten heeft, toon dan een duidelijke melding
                    const errorData = await response.json();
                    / Gebruik een console.error in plaats van alert, om de gebruiker niet te storen
                    console.error(`Fout bij het ophalen van data voor ${user}: ${errorData.message}`);
                    throw new Error(`HTTP-fout! status: ${response.status}`);
                }
                const data = await response.json();
                return data;
            } catch (error) {
                console.error(`Fout bij het ophalen van aanwezigheidsdata voor ${user}:`, error);
                / Retourneer een lege array om de UI te laten zien dat er geen data is
                return [];
            }
        }
        
        /**
         * Haalt de specifieke hostdata (dagen) op voor een gebruiker.
         * @param {string} user - De naam van de gebruiker.
         * @returns {Promise<Array<string>>} Een promise die resulteert in een array van datums.
         */
        async function fetchUserHostDates(user) {
            try {
                const response = await fetch(`${API_URL}/hosts/gebruiker/${encodeURIComponent(user)}`, {
                    credentials: 'include'
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    console.error(`Fout bij het ophalen van hostdata voor ${user}: ${errorData.message}`);
                    throw new Error(`HTTP-fout! status: ${response.status}`);
                }
                const data = await response.json();
                return data;
            } catch (error) {
                console.error(`Fout bij het ophalen van hostdata voor ${user}:`, error);
                return [];
            }
        }

        /**
         * Haalt hostgegevens op voor alle gebruikers.
         * @returns {Promise<Array<{user: string, count: number}>>} Een promise die resulteert in een array met hostgegevens.
         */
        async function fetchAllHostsSummary() {
            try {
                const response = await fetch(`${API_URL}/hosts/summary`, {
                    credentials: 'include'
                });
                if (!response.ok) {
                    throw new Error(`HTTP-fout! status: ${response.status}`);
                }
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('Fout bij het ophalen van hostgegevens:', error);
                return [];
            }
        }

        /**
         * Tekent een cirkeldiagram op een canvas.
         * @param {string} canvasId - De ID van het canvas-element.
         * @param {Array<{user: string, count: number}>} data - De gegevens om te plotten.
         * @param {HTMLElement} legendDiv - Het div-element voor de legenda.
         * @param {number} totalThursdaysBasis - Het totale aantal donderdagen dat als basis voor de percentageberekening wordt gebruikt.
         * @param {string} chartType - 'attendance' of 'hosts' om het legendaformaat en de tekst op de grafiek te bepalen.
         * @returns {Array<Object>} Een array met slice-gegevens voor hover-detectie.
         */
        function drawPieChart(canvasId, data, legendDiv, totalThursdaysBasis, chartType) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) {
                console.error(`Canvas met ID '${canvasId}' niet gevonden.`);
                return []; / Lege array retourneren als canvas niet gevonden is
            }
            const ctx = canvas.getContext('2d');
            / Wis vorige tekening
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            const total = data.reduce((sum, item) => sum + item.count, 0);
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const radius = Math.min(centerX, centerY) * 0.8; / 80% van de kleinste dimensie

            let currentAngle = 0;
            const slices = []; / Array om slice-gegevens op te slaan voor hover-detectie
            legendDiv.innerHTML = ''; / Wis vorige legenda

            if (total === 0) {
                ctx.font = '16px Inter';
                ctx.textAlign = 'center';
                ctx.fillStyle = '#6b7280';
                ctx.fillText('Geen data beschikbaar', centerX, centerY);
                return []; / Lege array retourneren als er geen data is
            }

            data.forEach((item, index) => {
                const sliceAngle = (item.count / total) * 2 * Math.PI;
                / Gebruik kleuren uit het voorgedefinieerde palet
                const color = colorPalette[index % colorPalette.length]; 
                
                / Voorkom dat 'Niet gehost' een klikbare slice is
                const isClickable = (chartType === 'attendance' && item.user !== 'Niet aanwezig') ||
                                    (chartType === 'hosts' && item.user !== 'Niet gehost');

                ctx.beginPath();
                ctx.moveTo(centerX, centerY);
                ctx.arc(centerX, centerY, radius, currentAngle, currentAngle + sliceAngle);
                ctx.closePath();
                ctx.fillStyle = color;
                ctx.fill();
                ctx.strokeStyle = '#fff'; / Witte rand tussen slices
                ctx.lineWidth = 2;
                ctx.stroke();

                let legendText = '';
                let percentageForSlice = 0;

                if (chartType === 'attendance') {
                    / Gebruik de totale basis voor de percentageberekening
                    percentageForSlice = totalThursdaysBasis > 0 ? ((item.count / totalThursdaysBasis) * 100).toFixed(1) : 0;
                    
                    / Toon het juiste percentage en aantal, inclusief voor 'Overige'
                    if (item.user === 'Overige') {
                        legendText = `${item.user}: (${item.count}/${totalThursdaysBasis})`;
                    } else {
                        legendText = `${item.user}: (${item.count}/${totalThursdaysBasis})`;
                    }

                } else if (chartType === 'hosts') {
                    / Verwijder 'hosts' uit de legenda
                    legendText = `${item.user}: ${item.count}`;
                } else {
                    legendText = `${item.user}: ${item.count}`; / Terugval voor legenda
                }

                / Sla slice-gegevens op voor hover-detectie
                slices.push({
                    user: item.user,
                    count: item.count,
                    percentage: percentageForSlice, / Opgeslagen berekend percentage voor aanwezigheid
                    startAngle: currentAngle,
                    endAngle: currentAngle + sliceAngle,
                    color: color,
                    chartType: chartType / Sla grafiektype op voor tooltip-opmaak
                });

                / Toevoegen aan legenda
                const legendItem = document.createElement('div');
                / Maak de cursor-stijl afhankelijk van of het item klikbaar is
                legendItem.className = `flex items-center p-1 rounded-md ${isClickable || item.user === 'Overige' ? 'cursor-pointer hover:bg-gray-200' : 'cursor-default'}`;
                legendItem.innerHTML = `
                    <span class="inline-block w-4 h-4 rounded-full mr-2" style="background-color: ${color};"></span>
                    ${legendText}
                `;
                legendItem.setAttribute('data-user', item.user);
                
                / Voeg click event listener toe voor aanwezigheidsdiagram
                if (isClickable) {
                    if (item.user === 'Overige') {
                        / Speciale afhandeling voor de 'Overige' categorie
                        legendItem.addEventListener('click', () => {
                            displayOtherAttendeesModal(otherAttendeesData, totalThursdaysBasis);
                        });
                    } else {
                        legendItem.addEventListener('click', async () => {
                            const user = legendItem.dataset.user;
                            
                            attendanceDatesList.innerHTML = '<li>Laden...</li>';
                            attendanceModalOverlay.classList.remove('hidden');

                            let dates;
                            if (chartType === 'attendance') {
                                dates = await fetchUserAttendanceDates(user);
                                displayAttendanceModal(user, dates, item.count, totalThursdaysBasis);
                            } else if (chartType === 'hosts') {
                                dates = await fetchUserHostDates(user);
                                displayHostModal(user, dates);
                            }
                        });
                    }
                }
                
                legendDiv.appendChild(legendItem);
                currentAngle += sliceAngle;
            });
            return slices; / Retourneer de slice-gegevens
        }

        /**
         * Verwerkt de opgehaalde datums en toont de modal.
         * @param {string} user - De naam van de gebruiker.
         * @param {Array<string>} dates - De array met datums (ISO-formaat).
         * @param {number} attendanceCount - Het aantal keer dat de gebruiker aanwezig was.
         * @param {number} totalThursdays - Het totale aantal donderdagen tot vandaag.
         */
        function displayAttendanceModal(user, dates, attendanceCount, totalThursdays) {
            / Filter de datums om alleen de dagen tot en met vandaag te tonen
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const filteredDates = dates.filter(dateStr => new Date(dateStr) <= today);

            const percentage = totalThursdays > 0 ? ((attendanceCount / totalThursdays) * 100).toFixed(1) : 0;
            modalTitle.textContent = `Aanwezigheid ${user} (${percentage}%)`;
            attendanceDatesList.innerHTML = ''; / Leeg de lijst

            if (filteredDates.length > 0) {
                filteredDates.forEach(dateStr => {
                    const date = new Date(dateStr);
                    const formattedDate = date.toLocaleDateString('nl-NL', {
                        weekday: 'long',
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });
                    const listItem = document.createElement('li');
                    listItem.textContent = formattedDate;
                    attendanceDatesList.appendChild(listItem);
                });
            } else {
                const listItem = document.createElement('li');
                listItem.textContent = 'Geen aanwezigheidsdata gevonden tot vandaag.';
                attendanceDatesList.appendChild(listItem);
            }

            attendanceModalOverlay.classList.remove('hidden');
        }

        /**
         * Verwerkt de opgehaalde datums en toont de modal voor hosts.
         * @param {string} user - De naam van de gebruiker.
         * @param {Array<string>} dates - De array met datums (ISO-formaat).
         */
        function displayHostModal(user, dates) {
            / Filter de datums om alleen de dagen tot en met vandaag te tonen
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const filteredDates = dates.filter(dateStr => new Date(dateStr) <= today);

            modalTitle.textContent = `Gehost door ${user}`;
            attendanceDatesList.innerHTML = ''; / Leeg de lijst

            if (filteredDates.length > 0) {
                filteredDates.forEach(dateStr => {
                    const date = new Date(dateStr);
                    const formattedDate = date.toLocaleDateString('nl-NL', {
                        weekday: 'long',
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });
                    const listItem = document.createElement('li');
                    listItem.textContent = formattedDate;
                    attendanceDatesList.appendChild(listItem);
                });
            } else {
                const listItem = document.createElement('li');
                listItem.textContent = `Geen dagen gevonden waarop ${user} heeft gehost tot vandaag.`;
                attendanceDatesList.appendChild(listItem);
            }

            attendanceModalOverlay.classList.remove('hidden');
        }

        /**
         * Toont een modal met de individuele aanwezigen en hun datums voor de "Overige" categorie.
         * @param {Array<{user: string, count: number}>} otherUsers - Array van gebruikers die in de categorie "Overige" vallen.
         * @param {number} totalThursdays - Het totale aantal donderdagen tot vandaag.
         */
        async function displayOtherAttendeesModal(otherUsers, totalThursdays) {
            const totalOtherCount = otherUsers.reduce((sum, user) => sum + user.count, 0);
            const totalOtherPercentage = totalThursdays > 0 ? ((totalOtherCount / totalThursdays) * 100).toFixed(1) : 0;

            modalTitle.textContent = `Aanwezigheid overige (${totalOtherPercentage}%)`;
            attendanceDatesList.innerHTML = '<li>Laden...</li>';
            attendanceModalOverlay.classList.remove('hidden');

            const allAttendeesContainer = document.createElement('div');
            allAttendeesContainer.className = 'space-y-4';

            if (otherUsers.length > 0) {
                for (const user of otherUsers) {
                    const userDates = await fetchUserAttendanceDates(user.user);
                    const userPercentage = totalThursdays > 0 ? ((user.count / totalThursdays) * 100).toFixed(1) : 0;
                    
                    const userItemDiv = document.createElement('div');
                    const userHeader = document.createElement('p');
                    userHeader.className = 'font-bold';
                    userHeader.textContent = `${user.user}: ${user.count} dagen (${userPercentage}%)`;
                    userItemDiv.appendChild(userHeader);

                    const datesSubList = document.createElement('ul');
                    datesSubList.className = 'list-disc list-inside space-y-1 ml-4 text-sm';
                    if (userDates.length > 0) {
                        const today = new Date();
                        today.setHours(0, 0, 0, 0);
                        const filteredDates = userDates.filter(dateStr => new Date(dateStr) <= today);

                        filteredDates.forEach(dateStr => {
                            const date = new Date(dateStr);
                            const formattedDate = date.toLocaleDateString('nl-NL', {
                                weekday: 'long',
                                year: 'numeric',
                                month: 'long',
                                day: 'numeric'
                            });
                            const dateListItem = document.createElement('li');
                            dateListItem.textContent = formattedDate;
                            datesSubList.appendChild(dateListItem);
                        });
                    } else {
                        const noDataListItem = document.createElement('li');
                        noDataListItem.textContent = 'Geen data gevonden.';
                        datesSubList.appendChild(noDataListItem);
                    }
                    userItemDiv.appendChild(datesSubList);
                    allAttendeesContainer.appendChild(userItemDiv);
                }
            } else {
                const paragraph = document.createElement('p');
                paragraph.textContent = 'Geen gebruikers in de categorie "Overige".';
                allAttendeesContainer.appendChild(paragraph);
            }

            attendanceDatesList.innerHTML = ''; / Clear the initial loading message
            attendanceDatesList.appendChild(allAttendeesContainer);
        }

        /**
         * Hulpfunctie om de muispositie ten opzichte van het canvas te krijgen.
         * @param {HTMLCanvasElement} canvas - Het canvas-element.
         * @param {MouseEvent} evt - De muisgebeurtenis.
         * @returns {{x: number, y: number}} De muiscoördinaten.
         */
        function getMousePos(canvas, evt) {
            const rect = canvas.getBoundingClientRect();
            return {
                x: evt.clientX - rect.left,
                y: evt.clientY - rect.top
            };
        }

        /**
         * Verwerkt muisbewegingen over een cirkeldiagramcanvas om tooltips weer te geven.
         * @param {MouseEvent} event - De muisgebeurtenis.
         * @param {HTMLCanvasElement} canvas - Het canvas-element.
         * @param {Array<Object>} slices - Array met slice-gegevens van drawPieChart.
         * @param {HTMLElement} tooltipElement - Het HTML-element van de tooltip.
         */
        function handlePieChartMouseMove(event, canvas, slices, tooltipElement) {
            const mousePos = getMousePos(canvas, event);
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const dx = mousePos.x - centerX;
            const dy = mousePos.y - centerY;
            const distance = Math.sqrt(dx * dx + dy * dy);
            const radius = Math.min(centerX, centerY) * 0.8; / Zelfde straal als de tekening

            if (distance > radius) { / Muis is buiten de taart
                tooltipElement.style.opacity = 0;
                return;
            }

            let angle = Math.atan2(dy, dx);
            if (angle < 0) angle += 2 * Math.PI; / Normaliseer hoek naar 0-2PI

            let hoveredSlice = null;
            for (const slice of slices) {
                / Controleer of de hoek binnen de slice valt EN de muis binnen de straal van de taart is
                if (angle >= slice.startAngle && angle < slice.endAngle && distance <= radius) {
                    hoveredSlice = slice;
                    break;
                }
            }

            if (hoveredSlice) {
                let tooltipText = '';
                if (hoveredSlice.chartType === 'attendance') {
                    / Gebruik het vooraf berekende percentage uit het slice-object
                    tooltipText = `${hoveredSlice.user}: ${hoveredSlice.count} dagen (${hoveredSlice.percentage}%)`;
                } else if (hoveredSlice.chartType === 'hosts') {
                    / Verwijder 'hosts' uit de tooltip
                    tooltipText = `${hoveredSlice.user}: ${hoveredSlice.count}`;
                }

                tooltipElement.textContent = tooltipText;
                / Positioneer de tooltip met een kleine offset van de cursor
                tooltipElement.style.left = `${event.clientX + window.scrollX + 10}px`;
                tooltipElement.style.top = `${event.clientY + window.scrollY + 10}px`;
                tooltipElement.style.opacity = 1;
            } else {
                tooltipElement.style.opacity = 0;
            }
        }

        /**
         * Verwerkt de mouse out-gebeurtenis voor het cirkeldiagramcanvas om de tooltip te verbergen.
         * @param {HTMLElement} tooltipElement - Het HTML-element van de tooltip.
         */
        function handlePieChartMouseOut(tooltipElement) {
            tooltipElement.style.opacity = 0;
        }


        /**
         * Laadt alle statistieken, haalt gegevens op en werkt de weergave-elementen op de pagina bij.
         */
        async function loadStatistics() {
            console.log(`Poging om gegevens op te halen van API_URL: ${API_URL}`); / Log de gebruikte API URL

            const currentYear = new Date().getUTCFullYear();
            numThursdaysUntilToday = calculateThursdaysUntilToday(); / Wijs toe aan de globale variabele
            const totalThursdaysInYear = calculateTotalThursdaysInYear(currentYear);
            const numRemainingThursdays = calculateRemainingThursdays();

            / --- Statistieken voor alle gebruikers (voor grafieken) ---
            const [attendanceSummary, hostsSummary] = await Promise.all([
                fetchAllAttendanceSummary(),
                fetchAllHostsSummary()
            ]);

            console.log('Ruwe aanwezigheidsgegevens voor grafieken:', attendanceSummary); / Toegevoegd voor debugging
            console.log('Ruwe hostgegevens voor grafieken:', hostsSummary); / Toegevoegd voor debugging

            / -------------------------------------------------------------------------------------
            / NIEUWE LOGICA: Groepeer aanwezigen met minder dan 5% in een "Overige" categorie
            / -------------------------------------------------------------------------------------
            const attendanceThreshold = numThursdaysUntilToday * 0.05; / 5% drempel
            const majorAttendees = [];
            const otherAttendees = [];
            let otherCount = 0;

            attendanceSummary.forEach(item => {
                if (item.count >= attendanceThreshold) {
                    majorAttendees.push(item);
                } else {
                    otherAttendees.push(item);
                    otherCount += item.count;
                }
            });
            
            / Sla de "Overige" data globaal op voor de modal
            otherAttendeesData = otherAttendees;

            if (otherAttendees.length > 0) {
                majorAttendees.push({ user: 'Overige', count: otherCount });
            }

            / Bereid gegevens voor aanwezigheidscirkeldiagram voor
            / De 'Niet aanwezig' categorie is niet nodig omdat de percentages nu gebaseerd zijn op de totale donderdagen.
            / Aangezien we de data al filteren, is de 'Niet aanwezig' slice niet meer nodig.
            const chartAttendanceData = majorAttendees.filter(item => item.count > 0);
            const attendanceSlices = drawPieChart('attendancePieChart', chartAttendanceData, attendanceLegendDiv, numThursdaysUntilToday, 'attendance');

            / Bereid gegevens voor hostcirkeldiagram voor, inclusief "Niet gehost"
            let chartHostsData = hostsSummary.filter(item => item.count > 0);
            const totalHostedCount = chartHostsData.reduce((sum, item) => sum + item.count, 0);
            const unhostedCount = numThursdaysUntilToday - totalHostedCount;

            if (unhostedCount > 0) {
                chartHostsData.push({ user: 'Niet gehost', count: unhostedCount });
            }
            const hostsSlices = drawPieChart('hostsPieChart', chartHostsData, hostsLegendDiv, numThursdaysUntilToday, 'hosts');

            / Voeg gebeurtenislisteners toe voor hover-functionaliteit
            attendancePieChartCanvas.addEventListener('mousemove', (e) => handlePieChartMouseMove(e, attendancePieChartCanvas, attendanceSlices, tooltip));
            attendancePieChartCanvas.addEventListener('mouseout', () => handlePieChartMouseOut(tooltip));

            hostsPieChartCanvas.addEventListener('mousemove', (e) => handlePieChartMouseMove(e, hostsPieChartCanvas, hostsSlices, tooltip));
            hostsPieChartCanvas.addEventListener('mouseout', () => handlePieChartMouseOut(tooltip));
        }

        / Voeg click event listener toe voor de sluitknop van de modal
        closeModalBtn.addEventListener('click', () => {
            attendanceModalOverlay.classList.add('hidden');
        });

        / Roep de functies aan bij het laden van de pagina
        window.onload = () => {
            loadStatistics();
        };
    </script>
</body>
</html>
