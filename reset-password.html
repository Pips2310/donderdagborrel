<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Wachtwoord Instellen</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="style.css">
</head>
<body class="min-h-screen flex items-center justify-center p-4 bg-gray-100">
  <!-- De "modal-content" klasse wordt nu gebruikt, gelijk aan de andere modals. -->
  <div class="modal-content w-full sm:w-96">
    <h2>Wachtwoord Instellen</h2>
    <form id="resetForm" onsubmit="event.preventDefault(); resetPassword();">
      <!-- De labels hebben nu dezelfde styling als de andere formulieren. -->
      <label for="newPassword" class="block text-left text-sm font-medium text-gray-700 mb-1">Nieuw wachtwoord</label>
      <div class="password-input-container">
        <!-- De inputvelden gebruiken nu de algemene modal-input styling. -->
        <input type="password" id="newPassword" required class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 mb-4" />
        <span class="toggle-password" id="toggleNewPassword">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
            <path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z" />
            <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
          </svg>
        </span>
      </div>

      <label for="confirmPassword" class="block text-left text-sm font-medium text-gray-700 mb-1">Bevestig wachtwoord</label>
      <div class="password-input-container">
        <input type="password" id="confirmPassword" required class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 mb-2" />
        <span class="toggle-password" id="toggleConfirmPassword">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
            <path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z" />
            <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
          </svg>
        </span>
      </div>
      <p id="errorMsg" class="text-sm text-red-600 mb-2 hidden"></p>

      <button type="submit" class="w-full py-2.5 bg-blue-600 text-white font-semibold rounded-md hover:bg-blue-700 transition duration-300 ease-in-out mt-6">
        Wachtwoord instellen
      </button>
    </form>
  </div>

  <script>
    const API_URL = 'http://localhost:3000/api';

    function getQueryParam(name) {
      const params = new URLSearchParams(window.location.search);
      return params.get(name);
    }

    // Function to toggle password visibility. This function is now also in script.js
    // for use in other modals, but it's kept here for this standalone page.
    function togglePasswordVisibility(inputEl, iconEl) {
      const type = inputEl.getAttribute('type') === 'password' ? 'text' : 'password';
      inputEl.setAttribute('type', type);
      if (type === 'password') {
        iconEl.innerHTML = `
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
            <path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z" />
            <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
          </svg>`;
      } else {
        iconEl.innerHTML = `
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
            <path stroke-linecap="round" stroke-linejoin="round" d="M3.988 5.89L10.5 12.396M16.5 17.5L20.012 21.012M12 16.5a4.5 4.5 0 100-9 4.5 4.5 0 000 9z" />
            <path stroke-linecap="round" stroke-linejoin="round" d="M21.012 21.012L3 3M12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z" />
          </svg>`;
      }
    }

    document.getElementById('toggleNewPassword').addEventListener('click', () => {
      togglePasswordVisibility(document.getElementById('newPassword'), document.getElementById('toggleNewPassword'));
    });
    document.getElementById('toggleConfirmPassword').addEventListener('click', () => {
      togglePasswordVisibility(document.getElementById('confirmPassword'), document.getElementById('toggleConfirmPassword'));
    });

    async function resetPassword() {
      const token = getQueryParam('token');
      const newPassword = document.getElementById('newPassword').value.trim();
      const confirmPassword = document.getElementById('confirmPassword').value.trim();
      const errorMsg = document.getElementById('errorMsg');

      errorMsg.classList.add('hidden');
      errorMsg.textContent = '';

      if (!token) {
        errorMsg.textContent = 'Resetlink is ongeldig of ontbreekt.';
        errorMsg.classList.remove('hidden');
        return;
      }
      if (!newPassword || !confirmPassword) {
        errorMsg.textContent = 'Vul beide velden in.';
        errorMsg.classList.remove('hidden');
        return;
      }
      if (newPassword !== confirmPassword) {
        errorMsg.textContent = 'Wachtwoorden komen niet overeen.';
        errorMsg.classList.remove('hidden');
        return;
      }

      try {
        const res = await fetch(`${API_URL}/reset-password`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ token, newPassword })
        });
        const data = await res.json();
        if (!res.ok) {
          errorMsg.textContent = data.message || 'Er ging iets mis. Probeer het opnieuw.';
          errorMsg.classList.remove('hidden');
          return;
        }
        // Succes: ga terug naar het inlogscherm
        window.location.href = 'index.html';
      } catch (e) {
        errorMsg.textContent = 'Netwerkfout. Probeer het opnieuw.';
        errorMsg.classList.remove('hidden');
      }
    }
  </script>
</body>
</html>
